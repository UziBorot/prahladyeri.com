<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <title>Prahlad Yeri - Freelance Programmer - LibreOffice</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri - Freelance Programmer Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Prahlad Yeri - Freelance Programmer </a></h1>
                <nav><ul>
				<li><a href="/">Home</a></li> <!--hard coded-->
                    <li><a href="/about">About</a></li>
                    <li><a href="/projects">Projects</a></li>
                    <li><a href="/hire-me">Hire Me</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/blog/2016/02/ten-libreoffice-macro-recipes.html">Ten useful LibreOffice Macro Recipes</a></h1>
<footer class="post-info">
        <abbr class="published" title="2016-02-26T02:23:00+05:30">
                Published: Fri 26 February 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/prahlad-yeri.html">Prahlad Yeri</a>
        </address>
<p>In <a href="/category/linux-technology.html">Linux, Technology</a>.</p>
<p>tags: <a href="/tag/libreoffice.html">LibreOffice</a> <a href="/tag/linux.html">Linux</a> </p>
</footer><!-- /.post-info --><p>Macros are a great way to automate tasks in Spreadsheet applications, be it the good old Microsoft Excel or the equally efficient FOSS alternative, LibreOffice Calc. The best thing about macros is that they are written in a very easy language called <a href="https://en.wikipedia.org/wiki/BASIC">Basic</a>.<!--more--></p>
<p><img alt="LibreOffice Logo" src="/uploads/old/libreofficeCalcLogo.jpg">\
<small>© The LibreOffice Project</small></p>
<p>As it’s very name suggests, Basic is a lenient programming language actually designed with ease of use in mind. For instance, upper/lower case doesn’t matter for variable names or keywords (<code class="highlighter-rouge">if/IF</code>, <code class="highlighter-rouge">sub/Sub</code>, <code class="highlighter-rouge">function/Function</code> are equivalents), function braces are optional like Ruby and type-conversion happens automatically. This makes Basic equally useful for both power users and programmers. A LibreOffice Basic macro is just a function or sub procedure which does a specific useful task. In this tutorial, we will see ten such useful macros that can help you with various automation tasks.</p>
<ol>
<li><a href="#howto">Recipe 0: How to create a LibreOffice macro</a></li>
<li><a href="#readcell">Recipe 1: Read cell contents</a></li>
<li><a href="#changecell">Recipe 2: Change cell contents</a></li>
<li><a href="#searchandrepl">Recipe 3: Search and Replace text</a></li>
<li><a href="#regex">Recipe 4: Regular Expressions</a></li>
<li><a href="#showopendialog">Recipe 5: Show File-open dialog</a></li>
<li><a href="#showsavedialog">Recipe 6: Show File-save dialog</a></li>
<li><a href="#readfromfiles">Recipe 7: File I/O: Read from files</a></li>
<li><a href="#writetofiles">Recipe 8: File I/O: Write to files</a></li>
<li><a href="#loadfromcsv">Recipe 9: Load data from a CSV file</a></li>
<li><a href="#copytoclipboard">Recipe 10: Copy text to clipboard</a></li>
<li><a href="#demo">Demo</a></li>
<li><a href="#references">References</a></li>
</ol>
<h2 id="recipe-0-how-to-create-a-libreoffice-macro-">Recipe 0: How to create a LibreOffice macro []{#howto}</h2>
<p>Whilst macros can be created in Writer and Draw too, in this specific tutorial, we will restrict ourselves to spreadsheets (Calc). To create a macro, just open the spreadsheet in LibreOffice and go to <code class="highlighter-rouge">Tools-&gt;Macros-&gt;Organize Macros-&gt;LibreOffice Basic</code> menu. After that, if you want to create a macro specific to your spreadsheet (as usually is the case), expand your spreadsheet file on left and select <code class="highlighter-rouge">Standard</code> and click <code class="highlighter-rouge">New</code>. This will open the LibreOffice Macro Editor as a separate window.</p>
<p><img alt="Macros Menu" src="/uploads/old/macros_menu.png"></p>
<h2 id="recipe-1-read-cell-contents-">Recipe 1: Read cell contents []{#readcell}</h2>
<p>One of the most basic things needed for automation is reading a cell’s contents. The following piece of code does exactly this:</p>
<figure class="highlight">
    Sub read_cell
        dim document as object
        document = ThisComponent
        sheet = document.Sheets(0)
        MsgBox(sheet.getCellByPosition(0, 0).String)
    End Sub

</figure>

<p><code class="highlighter-rouge">dim</code> is a keyword used to declare a variable but declaration is totally optional unless <code class="highlighter-rouge">Option Explicit</code> is specified at the beginning of the module. <code class="highlighter-rouge">ThisComponent</code> is the LibreOffice object that references the current spreadsheet (or a written document in case of Writer). The important thing here is the expression, <code class="highlighter-rouge">sheet.getCellByPosition(0, 0).String</code> which gets the contents of first cell in the first row. Cells can be referenced using the co-ordinate system where (0,0) refers to cell at row-0 and column-0. Thus, any value across the entire spreadsheet can be fetched using this simple method.</p>
<p>To run a macro from the editor, just place the cursor inside the <code class="highlighter-rouge">sub</code> or <code class="highlighter-rouge">function</code> body of any macro and press <code class="highlighter-rouge">F5</code> (or alternatively, click the <code class="highlighter-rouge">Run BASIC</code> icon on the toolbar).</p>
<h2 id="recipe-2-change-cell-contents-">Recipe 2: Change cell contents []{#changecell}</h2>
<p>Another often needed thing is the ability to change the cell contents. The following code sets the first cell in the first row to “Hola! Mundo”, the Spanish expression for “Hello! World”:</p>
<figure class="highlight">
    Sub change_cell
        dim document as object
        document = ThisComponent
        sheet = document.Sheets(0)
        sheet.getCellByPosition(0, 0).String = "Hola Mundo!"
        MsgBox("Done")
    End Sub

</figure>

<h2 id="recipe-3-search-and-replace-">Recipe 3: Search and Replace []{#searchandrepl}</h2>
<p>Searching and replacing specific strings could be an important part of your automation routine. Below is a fun macro that searches for the first names of some Linux experts (like Linus, Richard, Peter, etc.) and replaces it with their last names (Torvalds, Stallman, Anvin):</p>
<figure class="highlight">
    Sub replace_text
      Dim names() As String
      Dim surnames() As String
      Dim n As Long
      Dim document As Object
      Dim sheets as Object
      Dim sheet as Object
      Dim replace As Object

      names() = Array("Linus", "Richard", "Peter", "Greg", "Bill")
      surnames() = Array("Torvalds", "Stallman", "Anvin", "Kroah", "Gates")
      document = ThisComponent rem .CurrentController.Frame
      rem sheet = doc.CurrentSelection.Spreadsheet
      sheets = document.getSheets()
      sheet = sheets.getByIndex(0)
      replace = sheet.createReplaceDescriptor rem document.createReplaceDescriptor in case of Writer
      rem replace.SearchRegularExpression = True
      For n = lbound(names()) To ubound(names())
        replace.SearchString = names(n)
        replace.ReplaceString = surnames(n)
        sheet.replaceAll(replace)
      Next n
      MsgBox("Done")
    End Sub

</figure>

<p><code class="highlighter-rouge">names()</code> and <code class="highlighter-rouge">surnames()</code> are actually arrays. Unlike C and Java, arrays in Basic are declared and accessed using round braces and not square ones. Also, what gets declared in an array declaration is the upper-bound, not the total size. Thus, <code class="highlighter-rouge">foo(2)</code> is actually a size-3 array ranging from indices 0 to 2.</p>
<h2 id="recipe-4-regular-expressions-">Recipe 4: Regular Expressions []{#regex}</h2>
<p>Regular expressions are very useful in searching and replacing text based on specific patterns. The following macro searches for all the email addresses in your spreadsheet and replaces each one with <code class="highlighter-rouge">foo@bar.com</code>:</p>
<figure class="highlight">
    Sub replace_with_regex
      Dim names() As String
      Dim surnames() As String
      Dim n As Long
      Dim document As Object
      Dim sheets as Object
      Dim sheet as Object
      Dim replace As Object

      pattern = "\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b" rem regex pattern to match any email address
      document = ThisComponent rem .CurrentController.Frame
      sheets = document.getSheets()
      sheet = sheets.getByIndex(0)
      replace = sheet.createReplaceDescriptor rem document.createReplaceDescriptor in case of Writer
      replace.SearchRegularExpression = True
      replace.SearchString = pattern
      replace.ReplaceString = "foo@bar.com"
      sheet.replaceAll(replace)

      MsgBox("Done")
    End Sub

</figure>

<h2 id="recipe-5-show-file-open-dialog-">Recipe 5: Show File-open dialog []{#showopendialog}</h2>
<p>Showing the File-open dialog is a very common requirement, especially when you want to open an external file for processing. The below code uses the <code class="highlighter-rouge">FilePicker</code> object to show the file-open dialog and return the selected file-name:</p>
<figure class="highlight">
    function show_open_dialog
        dim aurl as object
        dim s as string
        dim oDlg as object

        oDlg = createUnoService("com.sun.star.ui.dialogs.FilePicker")
        oDlg.setMultiSelectionMode(false)
        oDlg.appendFilter("CSV Files (.csv)", "*.csv" ) 
        oDlg.execute
        aUrl = oDlg.getFiles()

        s = aUrl(0)
        if len(s) > 0 then
            MsgBox("File Selected: " & s & chr(13))
        end if
        show_open_dialog = s
    end function

</figure>

<p><code class="highlighter-rouge">createUnoService</code> is a LibreOffice specific method for creating helper objects like <code class="highlighter-rouge">FilePicker</code> in this example. The <code class="highlighter-rouge">appendFilter</code> method is used to filter out only <code class="highlighter-rouge">CSV</code> files in the dialog.</p>
<h2 id="recipe-6-show-file-save-dialog-">Recipe 6: Show File-save dialog []{#showsavedialog}</h2>
<p>For showing a File-save dialog, the same <code class="highlighter-rouge">FilePicker</code> object is used, initializing it with the <code class="highlighter-rouge">FILESAVE_AUTOEXTENSION</code> argument:</p>
<figure class="highlight">
    function show_save_dialog
        dim aurl as object
        dim s as string
        dim oDlg as object

        sFilePickerArgs = Array(_
        com.sun.star.ui.dialogs.TemplateDescription.FILESAVE_AUTOEXTENSION )    
        oDlg = createUnoService("com.sun.star.ui.dialogs.FilePicker")
        oDlg.initialize(sFilePickerArgs())
        oDlg.setMultiSelectionMode(false)
        oDlg.appendFilter("CSV Files (.csv)", "*.csv" ) 
        oDlg.setTitle("Save As....")

        if oDlg.execute() then
            aUrl = oDlg.getFiles()
            s = aUrl(0)
            if len(s) > 0 then
                MsgBox("File Selected: " & s & chr(13))
            end if
        else
            s = ""
        end if
        show_save_dialog = s
    end function

</figure>

<h2 id="recipe-7-file-io-read-from-files-">Recipe 7: File I/O: Read from files []{#readfromfiles}</h2>
<p>Raw file I/O is a feature provided by almost every language and Basic macros make it almost too easy. Below code is used to read a CSV file with three columns. Name of the file is set in the <code class="highlighter-rouge">filename</code> variable. The variable <code class="highlighter-rouge">num</code> is a numerical tag used to reference the file-handler and <code class="highlighter-rouge">FreeFile()</code> returns a free available number that can be used for tagging. The <code class="highlighter-rouge">open</code> statement is self-explanatory. In Basic, files can be opened in Input, Output and Binary modes. Finally, the <code class="highlighter-rouge">input</code> statement is used to actually read the file into the variables line after line.</p>
<figure class="highlight">
    sub file_io_read
        dim v1, v2, v3
        filename = "/home/prahlad/data/test.csv"
        num = FreeFile()
        open filename for input as #num 
        do while not eof(num)
            input #num, v1, v2, v3
            print v1 & "::" & v2 & "::" & v3
        loop
        close #num
        msgbox "Done"
    end sub

</figure>

<h2 id="recipe-8-file-io-write-to-files-">Recipe 8: File I/O: Write to files []{#writetofiles}</h2>
<p>For writing to files, a handler is opened in <code class="highlighter-rouge">output</code> mode instead of <code class="highlighter-rouge">input</code>, and the <code class="highlighter-rouge">write</code> statement is used to actually write the variables to a file.</p>
<figure class="highlight">
    sub file_io_write
        filename = "/home/prahlad/data/dummy.csv"
        num = FreeFile()
        open filename for output as #num 
        write #num, "col1", "col2", "col3"
        write #num, "1", "2", "3"
        write #num, "4", "5", "6"
        close #num
        msgbox "Done"
    end sub

</figure>

<h2 id="recipe-9-load-data-from-a-csv-file-">Recipe 9: Load data from a CSV file []{#loadfromcsv}</h2>
<p>Apart from working in raw I/O mode, it is sometimes required to load a complete CSV as a sheet in the current document. Using the <code class="highlighter-rouge">show_open_dialog</code> function that we studied earlier, the following macro first prompts a user with a File-open dialog and then loads the specified CSV file as a new sheet:</p>
<figure class="highlight">
    sub load_from_csv
        fname = show_open_dialog
        if len(fname)>0 then
            dim fileProps(1) as new com.sun.star.beans.PropertyValue
            fileProps(0).Name = "FilterName"
            fileProps(0).Value = "Text - txt - csv (StarCalc)"
            fileProps(1).Name = "FilterOptions"
            fileProps(1).Value = "44,34,76,1,,0,false,true,true,false"
            document = StarDesktop.loadComponentFromURL(fname, "_blank", 0, fileProps())        
        end if
        msgbox "Done"
    end sub

</figure>

<p><code class="highlighter-rouge">fileProps(0)</code> is a property variable used for specifying the CSV file format, while <code class="highlighter-rouge">fileProps(1)</code> specifies the default formatting options for the CSV (such as a delimiter, charset, etc.)</p>
<h2 id="recipe-10-copy-text-to-clipboard-">Recipe 10: Copy text to clipboard []{#copytoclipboard}</h2>
<p>Your custom processing might involve putting a specific text to the clipboard from LibreOffice Calc. Following code shows how to put the string “Hola!” to the system clipboard:</p>
<figure class="highlight">
    sub copy_to_clipboard
        oClip = CreateUnoService("com.sun.star.datatransfer.clipboard.SystemClipboard")
        oTR = createUnoListener("TR_", "com.sun.star.datatransfer.XTransferable")
        oClip.setContents(oTR, null)
        msgbox "Done"
    end sub

    Function TR_getTransferData( aFlavor As com.sun.star.datatransfer.DataFlavor ) As Any
        If (aFlavor.MimeType = "text/plain;charset=utf-16") Then
            TR_getTransferData = "Hola!"
        EndIf
    End Function

    Function TR_getTransferDataFlavors() As Any
        Dim aF As new com.sun.star.datatransfer.DataFlavor
        aF.MimeType = "text/plain;charset=utf-16"
        aF.HumanPresentableName = "Unicode-Text"
        TR_getTransferDataFlavors = Array(aF)
    End Function

    Function TR_isDataFlavorSupported( aFlavor As com.sun.star.datatransfer.DataFlavor ) As Boolean
        TR_isDataFlavorSupported = (aFlavor.MimeType = "text/plain;charset=utf-16")
    End Function

</figure>

<p>Second function is a callback and is used for storing the string to clipboard. The last two are helper functions used by the <code class="highlighter-rouge">SystemClipboard</code> and <code class="highlighter-rouge">XTransferable</code> helper objects and are required.</p>
<h2 id="demo-">Demo []{#demo}</h2>
<p>Finally, the working LibreOffice Calc spreadsheet implementing all these examples can be found <a href="/uploads/old/macro_recipes.ods">here</a>.</p>
<h2 id="references-">References []{#references}</h2>
<ul>
<li><a href="http://api.libreoffice.org/examples/examples.html#Basic_examples">http://api.libreoffice.org/examples/examples.html#Basic_examples</a></li>
<li><a href="https://forum.openoffice.org/en/forum/viewtopic.php?f=25&amp;t=36441">https://forum.openoffice.org/en/forum/viewtopic.php?f=25&amp;t=36441</a></li>
<li><a href="https://ask.libreoffice.org/en/question/39940/calc-open-and-save-csv-file-with-given-filter-options/">https://ask.libreoffice.org/en/question/39940/calc-open-and-save-csv-file-with-given-filter-options/</a></li>
<li><a href="https://wiki.openoffice.org/wiki/Documentation/DevGuide/OpenOffice.org_Developers_Guide">https://wiki.openoffice.org/wiki/Documentation/DevGuide/OpenOffice.org_Developers_Guide</a></li>
<li><a href="https://wiki.openoffice.org/wiki/Documentation/BASIC_Guide/Cells_and_Ranges">https://wiki.openoffice.org/wiki/Documentation/BASIC_Guide/Cells_and_Ranges</a></li>
<li><a href="http://www.excel-spreadsheet.com/vba/inputoutput.htm">http://www.excel-spreadsheet.com/vba/inputoutput.htm</a></li>
<li><a href="https://forum.openoffice.org/en/forum/viewtopic.php?f=45&amp;t=13783">https://forum.openoffice.org/en/forum/viewtopic.php?f=45&amp;t=13783</a></li>
</ul><p>There are <a href="/blog/2016/02/ten-libreoffice-macro-recipes.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="mailto:prahladyeri@yahoo.com">Email</a></li>
                            <li><a href="https://github.com/prahladyeri/">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/849365/prahlad-yeri/">StackOverflow</a></li>
                            <li><a href="https://www.quora.com/profile/Prahlad-Yeri-%E0%A4%AA%E0%A5%8D%E0%A4%B0%E0%A4%B9%E0%A5%8D%E0%A4%B2%E0%A4%BE%E0%A4%A6-%E0%A4%AF%E0%A5%87%E0%A4%B0%E0%A5%80">Quora</a></li>
                            <li><a href="https://mastodon.social/@prahladyeri">Mastodon.Social</a></li>
                            <li><a href="https://www.blogger.com/profile/12769325975373447545">Blogger</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a></li>
                            <li><a href="https://www.facebook.com/prahladyeri14">Facebook</a></li>
                            <li><a href="https://twitter.com/prahladyeri">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Copyright (c) 2013-2019 <a href="/">Prahlad Yeri</a>.
				<br>
				This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'https://prahladyeri-blog.disqus.com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>