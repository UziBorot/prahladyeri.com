<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <title>How to Generate PDFs in Python for Google App Engine</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri - Freelance Programmer Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Prahlad Yeri - Freelance Programmer </a></h1>
                <nav><ul>
				<li><a href="/">Home</a></li> <!--hard coded-->
                    <li><a href="/about/">About</a></li>
                    <li><a href="/projects/">Projects</a></li>
                    <li><a href="/hire-me/">Hire Me</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2013/11/how-to-generate-pdf-in-python-for-google-app-engine.html" rel="bookmark"
           title="Permalink to How to Generate PDFs in Python for Google App Engine">How to Generate PDFs in Python for Google App Engine</a></h1>
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="prahladyeri">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-11-26T19:07:00+05:30">
                Published: Tue 26 November 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/prahlad-yeri.html">Prahlad Yeri</a>
        </address>
<p>In <a href="/category/uncategorized.html">Uncategorized</a>.</p>

</footer><!-- /.post-info -->      <p>One of my last projects based on google app engine and python involved storing form data in GAE datastore and generating PDF documents that the user can download. Whilst data storing was the easier part as google's big data API it is pretty <a href="https://developers.google.com/appengine/docs/python/datastore/">well documented</a>, the trickier aspect was to convert it to PDF using python.<!--more--></p>
<p><a href="/uploads/old/pdf.png"><img alt="pdf" class="alignnone wp-image-164" height="108" src="/uploads/old/pdf-300x300.png" width="108"></a></p>
<p>This was especially difficult in the face of GAE not providing an easy mechanism for disk writing that most PDF generation libraries require. To share my endeavors, I'm writing this post about how to generate pdfs in python for Google app engine.</p>
<p>The solution I came across was, as far as I know, the only possible way of generating PDFs in python! There are about three PDF generation utilities in python, each differing in terms of their area of usage:</p>
<ul>
<li><a href="http://www.reportlab.com"><strong>Reportlab PDF library</strong></a>: This is the ideal library, if you want to create a pdf from scratch. It provides objects like canvas, pdfmetrics and ttfonts that help you with stuff like adding lines, shapes, images and paragraphs. This is pretty much comparable to the comprehensive iText java library or its C# port, iTextSharp. Their <a href="http://www.reportlab.com/software/documentation/">documentation</a> is also good.</li>
<li><a href="http://www.xhtml2pdf.com/"><strong>xhtml2pdf</strong></a>: If you want to simply convert an existing html document to pdf, the xhtml2pdf library comes in very handy.</li>
<li><a href="https://pypi.python.org/pypi/pyPdf"><strong>pyPDF</strong></a>: If all you want to do is merge two PDFs page by page quickly, this library is the way to go.</li>
</ul>
<p>I figured out after researching the above three libraries that a combination of xhtml2pdf and pyPDF is what I needed. Since I already had the html document template ready, I just put placeholders for my form data like __name__ , __occupation__, etc so that I can fill these before converting to PDF.</p>
<p>Now, I could fill these values from my python program, but the real challenge was storing the resulting PDF to disk, which was not allowed by google app engine! Turns out, we don't need to actually store anything to disk. By sending the CreatePDF() output to a <a href="http://docs.python.org/library/stringio.html">StringIO</a> object, which is stored in memory instead of the filesystem, I could bypass the need to actually store anything to disk!!</p>
<p>``` {lang="python"}
f=open('template.htm','r')
sourceHtml = unicode(f.read(), errors='ignore')
f.close()
sourceHtml = template.render(tvals)
sourceHtml = sourceHtml.replace('<strong>name</strong>',sname)
sourceHtml = sourceHtml.replace('<strong>address</strong>',saddress)
sourceHtml = sourceHtml.replace('<strong>occupation</strong>',will.occupation)
packet = StringIO.StringIO() #write to memory
pisa.CreatePDF(sourceHtml,dest=packet)</p>
<div class="highlight"><pre><span></span>Now, it would have been simple to just self.response.write(packet) to send this pdf download to the user, but in my case, I had to merge this generated pdf with another template-pdf which contained information like symbols, images and page-numbers that for some reason, could not be placed into the html document. So, I had to create a PdfFileReader object (coutesy of PyPDF library!), and then merge each page of my generated document with this template document. Then where do I write this merged output? Any guesses? - another StringIO object!! And then finally, write this StringIO object to self.response, so the user can download it.

``` {lang=&quot;python&quot;}
packet.seek(0)
new =PdfFileReader(packet) #generated pdf
template = PdfFileReader(file(&quot;template.pdf&quot;, &quot;rb&quot;)) #template pdf
output=PdfFileWriter() #writer for the merged pdf
for i in range(new.getNumPages()):
    page=template.getPage(i)
    page.mergePage(new.getPage(i))
    output.addPage(page)

outputStream = StringIO.StringIO()
output.write(outputStream) #write merged output to the StringIO object

self.response.headers[&#39;Content-Type&#39;] = &#39;application/pdf&#39;
fname = (will.name if mirror==&#39;n&#39; else will.partner)
self.response.headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=&#39; + str(fname).replace(&#39; &#39;,&#39;_&#39;) + &#39;.pdf&#39;
self.response.write(outputStream.getvalue())
</pre></div>


<p>Remember to add and include the below libraries before you do this:</p>
<p><code>{lang="python"}
import StringIO
import xhtml2pdf.pisa as pisa
from pyPdf import PdfFileWriter,PdfFileReader
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.pdfbase import pdfmetrics,ttfonts</code></p>
<address>
References:

</address>

<address>
<https://developers.google.com/appengine/docs/python/datastore/>

</address>

<address>
<http://www.reportlab.com/software/documentation/>

</address>

<address>
<http://www.xhtml2pdf.com/>

</address>

<address>
<https://pypi.python.org/pypi/pyPdf>

</address>

<address>
<http://stackoverflow.com/questions/4899885/how-to-set-any-font-in-reportlab-canvas-in-python>

</address>

<address>
<http://stackoverflow.com/questions/13522638/paginating-in-pisa-xhtml2pdf-just-repeats-last-page>

</address>

<address>
<http://docs.python.org/library/stringio.html>

</address>

<address>

</address>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="mailto:prahladyeri@yahoo.com">Email</a></li>
                            <li><a href="https://github.com/prahladyeri/">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/849365/prahlad-yeri/">StackOverflow</a></li>
                            <li><a href="https://www.quora.com/profile/Prahlad-Yeri-%E0%A4%AA%E0%A5%8D%E0%A4%B0%E0%A4%B9%E0%A5%8D%E0%A4%B2%E0%A4%BE%E0%A4%A6-%E0%A4%AF%E0%A5%87%E0%A4%B0%E0%A5%80">Quora</a></li>
                            <li><a href="https://mastodon.social/@prahladyeri">Mastodon.Social</a></li>
                            <li><a href="https://www.blogger.com/profile/12769325975373447545">Blogger</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a></li>
                            <li><a href="https://www.facebook.com/prahladyeri14">Facebook</a></li>
                            <li><a href="https://twitter.com/prahladyeri">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Copyright (c) 2013-2019 <a href="/">Prahlad Yeri</a>.
				<br>
				This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'https://prahladyeri-blog.disqus.com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>