<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <title>How to create a Google Drive App in Flask</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri - Freelance Programmer Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Prahlad Yeri - Freelance Programmer </a></h1>
                <nav><ul>
				<li><a href="/">Home</a></li> <!--hard coded-->
                    <li><a href="/about/">About</a></li>
                    <li><a href="/projects/">Projects</a></li>
                    <li><a href="/hire-me/">Hire Me</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/blog/2016/12/how-to-create-google-drive-app-python-flask.html" rel="bookmark"
           title="Permalink to How to create a Google Drive App in Flask">How to create a Google Drive App in Flask</a></h1>
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="prahladyeri">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-12-29T04:21:00+05:30">
                Published: Thu 29 December 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/prahlad-yeri.html">Prahlad Yeri</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>
<p>tags: <a href="/tag/flask.html">Flask</a> <a href="/tag/google-drive.html">Google Drive</a> <a href="/tag/python.html">Python</a> </p>
</footer><!-- /.post-info -->      <p>This is the first in a series of articles for web programmers that explain in detail about using the Google Drive API in your web applications to access files/folders on behalf of the users of your application. In my last project, I had to develop a python flask app for my users that required to access the files stored in their google drive account.<!--more--></p>
<p>The major challenge for me was to authenticate to google and access the drive on the user’s behalf once they grant permission to my app. This method of authentication is called <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> and is very much needed for implementing the drive api.</p>
<p>However, a good documentation to implement this in a backend app, especially a python web-based app is very much lacking. The so called <a href="https://developers.google.com/drive/v3/web/quickstart/python">quickstart for drive api</a> shows some example code, but what I needed was a step-by-step tutorial of how to go about doing it. Since I couldn’t find any such tutorial online, I thought about writing one myself.</p>
<h3>I: Register a google app by visiting the <a href="https://console.developers.google.com/">Google API console</a>:</h3>
<p>The way the latest version (V3) of drive API works is only through OAuth. It means you cannot put a password or API key inside your code and access the drive files. You need to register your backend app and generate OAuth credentials for the app, so that it can access the drive on the user’s behalf once the user grants permission to the app. So the first step is going to the <a href="https://console.developers.google.com/">Google API console</a>, registering the app itself and generating OAuth credentials. The registration process is pretty straightforward, you just select “Create Project” from the dropdown and give a nice name for your project such as <code class="highlighter-rouge">Flask Drive Example App</code> in our case.</p>
<p><img alt="Register Google App" src="/uploads/old/google-apis/drive_api_steps.png"></p>
<h3 id="ii-configure-the-credentials-and-download-the-client_idjson-file">II: Configure the credentials and download the client_id.json file:</h3>
<p>This is the credential file that validates to Google who you are (as a developer) and also your app that acts on your behalf. Download and save it as <code class="highlighter-rouge">client_id.json</code> in the same directory as the flask app.</p>
<p><img alt="Configure Credentials" src="/uploads/old/google-apis/configuration_steps.png"></p>
<h3>III: Write your back-end app:</h3>
<p>The most important thing to know before building your app is to install these dependencies:</p>
<div class="highlight"><pre><span></span>pip install flask google-api-python-client
</pre></div>


<p>You can replace flask with django, pylons or any other framework you use, but this tutorial and code example is based on flask. The principle of accessing the drive api should still apply, so you should be able to make use of this code.</p>
<p>The first thing to do is create a flask object and handle the home page url. It could in fact be any other url in your app, but in this example, I’ve used the home page url (/) to do the OAuth authentication on behalf of the logged in user.</p>
<div class="highlight"><pre><span></span>app = flask.Flask(__name__)

@app.route(&#39;/&#39;)
def index():
    credentials = get_credentials()
    if credentials == False:
        return flask.redirect(flask.url_for(&#39;oauth2callback&#39;))
    elif credentials.access_token_expired:
        return flask.redirect(flask.url_for(&#39;oauth2callback&#39;))
    else:
        print(&#39;now calling fetch&#39;)
        all_files = fetch(&quot;&#39;root&#39; in parents and mimeType = &#39;application/vnd.google-apps.folder&#39;&quot;, sort=&#39;modifiedTime desc&#39;)
        s = &quot;&quot;
        for file in all_files:
            s += &quot;%s, %s&lt;br&gt;&quot; % (file[&#39;name&#39;],file[&#39;id&#39;])
        return s
</pre></div>


<p>We first check whether we have the drive access credentials for the user locally stored in a file. This is done by the <code class="highlighter-rouge">get_credentials()</code> function that checks the local access token file credentials.json (not to be confused with client_id.json we downloaded earlier which is for developer credentials). Again, we are assuming a single user scenario here. If your drive app needs to authenticate with multiple users, you’ll have to store separate credentials.json for each logged-in user in the database, and access that through a session or something.</p>
<p>Further, if credentials aren’t found locally or have expired, we direct them to <code class="highlighter-rouge">/oauth2callback</code>, so google will authenticate them and send us the token for accessing the drive, post which, we will put that token into the local file, credentials.json and redirect the user back to this index site. Finally, if the credentials are valid, we call the <code class="highlighter-rouge">fetch()</code> function that displays the list of all root folders in that user’s drive along with their IDs. Here is the code for <code class="highlighter-rouge">oauth2callback</code>:</p>
<div class="highlight"><pre><span></span>@app.route(&#39;/oauth2callback&#39;)
def oauth2callback():
    flow = client.flow_from_clientsecrets(&#39;client_id.json&#39;,
            scope=&#39;https://www.googleapis.com/auth/drive&#39;,
            redirect_uri=flask.url_for(&#39;oauth2callback&#39;, _external=True)) # access drive api using developer credentials
    flow.params[&#39;include_granted_scopes&#39;] = &#39;true&#39;
    if &#39;code&#39; not in flask.request.args:
        auth_uri = flow.step1_get_authorize_url()
        return flask.redirect(auth_uri)
    else:
        auth_code = flask.request.args.get(&#39;code&#39;)
        credentials = flow.step2_exchange(auth_code)
        open(&#39;credentials.json&#39;,&#39;w&#39;).write(credentials.to_json()) # write access token to credentials.json locally
        return flask.redirect(flask.url_for(&#39;index&#39;))
</pre></div>


<p>Once you have the credentials locally (in the form of <code class="highlighter-rouge">credentials.json</code>), you can just use it to access the drive API. Thus, the result of this whole exercise is that only on first page load is the user redirected to google site to authenticate themselves. Once the app has the access token (credentials.json), its no longer required, the result is displayed directly on the page from then on. If all goes well, you should be able to see a screen such as this when you test this example app for the first time:</p>
<p><img alt="Google OAuth Screen" src="/uploads/old/google-apis/oauth_screen.png"></p>
<p>I’ve also included the functions to download and upload files to the drive as they will be very useful:</p>
<div class="highlight"><pre><span></span>def download_file(file_id, output_file):
    credentials = get_credentials()
    http = credentials.authorize(httplib2.Http())
    service = discovery.build(&#39;drive&#39;, &#39;v3&#39;, http=http)
    #file_id = &#39;0BwwA4oUTeiV1UVNwOHItT0xfa2M&#39;
    request = service.files().export_media(fileId=file_id,mimeType=&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;)
    #request = service.files().get_media(fileId=file_id)

    fh = open(output_file,&#39;wb&#39;) #io.BytesIO()
    downloader = MediaIoBaseDownload(fh, request)
    done = False
    while done is False:
        status, done = downloader.next_chunk()
        #print (&quot;Download %d%%.&quot; % int(status.progress() * 100))
    fh.close()
    #return fh

def update_file(file_id, local_file):
    credentials = get_credentials()
    http = credentials.authorize(httplib2.Http())
    service = discovery.build(&#39;drive&#39;, &#39;v3&#39;, http=http)
    # First retrieve the file from the API.
    file = service.files().get(fileId=file_id).execute()
    # File&#39;s new content.
    media_body = MediaFileUpload(local_file, resumable=True)
    # Send the request to the API.
    updated_file = service.files().update(
        fileId=file_id,
        #body=file,
        #newRevision=True,
        media_body=media_body).execute()
</pre></div>


<hr>
<p>I’ll leave the more comprehensive use of these functions as an exercise to the reader who wants to develop a more fully featured app out of this. Click the below link to download the <code class="highlighter-rouge">flask_drive_example.py</code> script for this example implementation from the Github gist:</p>
<p><a class="btn btn-md btn-success" href="https://gist.githubusercontent.com/prahladyeri/0b92b9ca837a0f5474c732876220db78"> flask_drive_example.py</a></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="mailto:prahladyeri@yahoo.com">Email</a></li>
                            <li><a href="https://github.com/prahladyeri/">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/849365/prahlad-yeri/">StackOverflow</a></li>
                            <li><a href="https://www.quora.com/profile/Prahlad-Yeri-%E0%A4%AA%E0%A5%8D%E0%A4%B0%E0%A4%B9%E0%A5%8D%E0%A4%B2%E0%A4%BE%E0%A4%A6-%E0%A4%AF%E0%A5%87%E0%A4%B0%E0%A5%80">Quora</a></li>
                            <li><a href="https://mastodon.social/@prahladyeri">Mastodon.Social</a></li>
                            <li><a href="https://www.blogger.com/profile/12769325975373447545">Blogger</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a></li>
                            <li><a href="https://www.facebook.com/prahladyeri14">Facebook</a></li>
                            <li><a href="https://twitter.com/prahladyeri">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Copyright (c) 2013-2019 <a href="/">Prahlad Yeri</a>.
				<br>
				This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'https://prahladyeri-blog.disqus.com';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>