<!DOCTYPE html>
<html lang="english">
<head>
        <meta charset="utf-8" />
        <title>How to create a Google Drive App in PHP</title>
        <link rel="stylesheet" href="https://prahladyeri.com/theme/css/main.css" />
        <link href="https://prahladyeri.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prahlad Yeri - Freelance Programmer Atom Feed" />
		
	<meta name="twitter:card" content="summary" />
	 <meta name="twitter:site" content="@prahladyeri" />
	 <meta name="twitter:creator" value="@prahladyeri" />
		<meta name="twitter:url" content="https://prahladyeri.com/blog/2017/01/how-to-create-google-drive-app-php.html" />
	 	 <meta name="twitter:title" content="How to create a Google Drive App in PHP" />
		<meta name="twitter:description" content="This is the second article in the drive series for web programmers that aims to explain how to use the Google Drive API in your web applications to access files/folders on behalf of your logged-in users. One of the basic tasks here is to authenticate to google and access …" />		
			<meta name="twitter:image" content="https://prahladyeri.com/uploads/cover.jpg" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://prahladyeri.com/">Prahlad Yeri - Freelance Programmer </a></h1>
                <nav><ul>
				<li><a href="/">Home</a></li> <!--hard coded-->
                    <li><a href="https://prahladyeri.com/about/">About</a></li>
                    <li><a href="https://prahladyeri.com/projects/">Projects</a></li>
                    <li><a href="https://prahladyeri.com/hire-me/">Hire Me</a></li>
				<li><a href="https://github.com/prahladyeri/resume">Resume</a></li> <!--hard coded-->
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://prahladyeri.com/blog/2017/01/how-to-create-google-drive-app-php.html" rel="bookmark"
           title="Permalink to How to create a Google Drive App in PHP">How to create a Google Drive App in PHP</a></h1>
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="prahladyeri">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-02T04:21:00+05:30">
                Published: Mon 02 January 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://prahladyeri.com/author/prahlad-yeri.html">Prahlad Yeri</a>
        </address>
<p>In <a href="https://prahladyeri.com/category/php.html">PHP</a>.</p>
<p>tags: <a href="https://prahladyeri.com/tag/google-drive.html">Google Drive</a> <a href="https://prahladyeri.com/tag/php.html">PHP</a> </p>
</footer><!-- /.post-info -->      <p>This is the second article in the drive series for web programmers that aims to explain how to use the Google Drive API in your web applications to access files/folders on behalf of your logged-in users.<!--more--></p>
<p>One of the basic tasks here is to authenticate to google and access the drive on the user’s behalf once they grant permission to your app. This method of authentication is called <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a> and is very much needed for implementing the drive api.</p>
<p>However, a good documentation to implement this in a backend app, especially a php app is very much lacking. The so called <a href="https://developers.google.com/drive/v3/web/quickstart/php">quickstart for drive api</a> and the web based example <a href="https://developers.google.com/api-client-library/php/auth/web-app">here</a> show some example code, but what a lot of beginner programmers need is a step-by-step tutorial of how to go about doing it.</p>
<h3>I: Register a google app by visiting the <a href="https://console.developers.google.com/">Google API console</a>:</h3>
<p>The way the latest version (V3) of drive API works is only through OAuth. It means you cannot put a password or API key inside your code and access the drive files. You need to register your backend app and generate OAuth credentials for the app, so that it can access the drive on the user’s behalf once the user grants permission to the app. So the first step is going to the <a href="https://console.developers.google.com/">Google API console</a>, registering the app itself and generating OAuth credentials. The registration process is pretty straightforward, we just select “Create Project” from the dropdown and give a nice name for the project such as <code class="highlighter-rouge">Drive Example App</code> in our case.</p>
<p><img alt="Register Google App" src="/uploads/old/google-apis/drive_api_steps.png"></p>
<h3 id="ii-configure-the-credentials-and-download-the-client_idjson-file">II: Configure the credentials and download the client_id.json file:</h3>
<p>This is the credential file that validates to Google who you are (as a developer) and also your app that acts on your behalf. Download and save it as <code class="highlighter-rouge">client_id.json</code> in the same directory as your app.</p>
<p><img alt="Configure Credentials" src="/uploads/old/google-apis/configuration_steps_generic1.png"></p>
<h3>III: Write your back-end app:</h3>
<p>First of all, you have to add the dependency of google-api php library to your project. If you are using composer, all you need to do is add this package to the composer.json:</p>
<div class="highlight"><pre><span></span>&quot;require&quot;: {
  &quot;google/apiclient&quot;: &quot;^2.0&quot;
}
</pre></div>


<p>If you don’t use composer, you can just download the latest version of library from <a href="https://github.com/google/google-api-php-client">their repo</a>, and just <code class="highlighter-rouge">require_once</code> it in your code like this:</p>
<p>::: {.highlighter-rouge}</p>
<div class="highlight"><pre><span></span>require_once &#39;/path/to/google-api-php-client/vendor/autoload.php&#39;;
</pre></div>


<p>:::</p>
<p>You can follow this pattern for any kind of php project, be it based on Symfony, Laravel, CodeIgniter or even a pure php project. But this tutorial and code example is based on a pure php project.</p>
<p>The first thing to do now is to handle the home page url (index.php).</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="nt">client</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">Google_Client</span><span class="o">();</span>
<span class="o">$</span><span class="nt">client-</span><span class="o">&gt;</span><span class="nt">setAuthConfig</span><span class="o">(</span><span class="s1">&#39;client_id.json&#39;</span><span class="o">);</span>
<span class="o">$</span><span class="nt">client-</span><span class="o">&gt;</span><span class="nt">addScope</span><span class="o">(</span><span class="nt">Google_Service_Drive</span><span class="p">::</span><span class="nd">DRIVE</span><span class="o">);</span>

<span class="nt">if</span> <span class="o">(</span><span class="nt">file_exists</span><span class="o">(</span><span class="s2">&quot;credentials.json&quot;</span><span class="o">))</span> <span class="p">{</span>
    <span class="err">$access_token</span> <span class="err">=</span> <span class="err">(file_get_contents(&quot;credentials.json&quot;))</span><span class="p">;</span>
    <span class="err">$client-&gt;setAccessToken($access_token)</span><span class="p">;</span>
    <span class="err">//Refresh</span> <span class="err">the</span> <span class="err">token</span> <span class="err">if</span> <span class="err">it&#39;s</span> <span class="err">expired.</span>
    <span class="err">if</span> <span class="err">($client-&gt;isAccessTokenExpired())</span> <span class="err">{</span>
        <span class="err">$client-&gt;fetchAccessTokenWithRefreshToken($client-&gt;getRefreshToken())</span><span class="p">;</span>
        <span class="err">file_put_contents($credentialsPath,</span> <span class="err">json_encode($client-&gt;getAccessToken()))</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">$</span><span class="nt">drive_service</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">Google_Service_Drive</span><span class="o">($</span><span class="nt">client</span><span class="o">);</span>
    <span class="o">$</span><span class="nt">files_list</span> <span class="o">=</span> <span class="o">$</span><span class="nt">drive_service-</span><span class="o">&gt;</span><span class="nt">files-</span><span class="o">&gt;</span><span class="nt">listFiles</span><span class="o">(</span><span class="nt">array</span><span class="o">())</span><span class="nt">-</span><span class="o">&gt;</span><span class="nt">getFiles</span><span class="o">();</span> 
    <span class="nt">echo</span> <span class="nt">json_encode</span><span class="o">($</span><span class="nt">files_list</span><span class="o">);</span>
<span class="err">}</span> <span class="nt">else</span> <span class="p">{</span>
  <span class="err">$redirect_uri</span> <span class="err">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="s1">&#39; . $_SERVER</span><span class="cp">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="cp">]</span><span class="s1"> . &#39;</span><span class="o">/</span><span class="n">oauth2callback</span><span class="o">.</span><span class="n">php</span><span class="s1">&#39;;</span>
<span class="s1">  header(&#39;</span><span class="n">Location</span><span class="o">:</span> <span class="err">&#39;</span> <span class="o">.</span> <span class="nf">filter_var</span><span class="p">(</span><span class="err">$</span><span class="n">redirect_uri</span><span class="p">,</span> <span class="n">FILTER_SANITIZE_URL</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>


<p>We first check whether we have the drive access credentials for the user locally stored in a file called credentials.json (not to be confused with client_id.json we downloaded earlier which is for developer credentials). Again, we are assuming a single user scenario here. If your drive app needs to authenticate with multiple users, you’ll have to store separate credentials.json for each logged-in user in the database, and access that through a session or something.</p>
<p>Further, if credentials aren’t found locally, we direct them to <code class="highlighter-rouge">/oauth2callback.php</code>, so google will authenticate them and send us the token for accessing the drive, and after that, we will put that token into the local file, credentials.json and redirect the user back to the index.php. Finally, we call the <code class="highlighter-rouge">listFiles()</code> method that displays the list of all files and folders in that user’s drive. Here is the code for <code class="highlighter-rouge">oauth2callback.php</code>:</p>
<div class="highlight"><pre><span></span><span class="o">$</span><span class="nt">client</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">Google_Client</span><span class="o">();</span>
<span class="o">$</span><span class="nt">client-</span><span class="o">&gt;</span><span class="nt">setAuthConfigFile</span><span class="o">(</span><span class="s1">&#39;client_id.json&#39;</span><span class="o">);</span>
<span class="o">$</span><span class="nt">client-</span><span class="o">&gt;</span><span class="nt">setRedirectUri</span><span class="o">(</span><span class="s1">&#39;http://&#39;</span> <span class="o">.</span> <span class="o">$</span><span class="nt">_SERVER</span><span class="cp">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="cp">]</span> <span class="o">.</span> <span class="s1">&#39;/oauth2callback.php&#39;</span><span class="o">);</span>
<span class="o">$</span><span class="nt">client-</span><span class="o">&gt;</span><span class="nt">addScope</span><span class="o">(</span><span class="nt">Google_Service_Drive</span><span class="p">::</span><span class="nd">DRIVE</span><span class="o">);</span> <span class="o">//</span><span class="p">::</span><span class="nd">DRIVE_METADATA_READONLY</span>

<span class="nt">if</span> <span class="o">(!</span> <span class="nt">isset</span><span class="o">($</span><span class="nt">_GET</span><span class="cp">[</span><span class="s1">&#39;code&#39;</span><span class="cp">]</span><span class="o">))</span> <span class="p">{</span>
  <span class="err">$auth_url</span> <span class="err">=</span> <span class="err">$client-&gt;createAuthUrl()</span><span class="p">;</span>
  <span class="err">header(&#39;</span><span class="n">Location</span><span class="p">:</span> <span class="s1">&#39; . filter_var($auth_url, FILTER_SANITIZE_URL));</span>
<span class="s1">} else {</span>
<span class="s1">  $client-&gt;authenticate($_GET</span><span class="cp">[</span><span class="s1">&#39;code&#39;</span><span class="cp">]</span><span class="s1">);</span>
<span class="s1">  $access_token = $client-&gt;getAccessToken();</span>
<span class="s1">  file_put_contents(&quot;credentials.json&quot;, json_encode($access_token));</span>

<span class="s1">  $redirect_uri = &#39;</span><span class="n">http</span><span class="o">://</span><span class="s1">&#39; . $_SERVER</span><span class="cp">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="cp">]</span><span class="s1"> . &#39;</span><span class="o">/</span><span class="s1">&#39;;</span>
<span class="s1">  header(&#39;</span><span class="n">Location</span><span class="o">:</span> <span class="err">&#39;</span> <span class="o">.</span> <span class="nf">filter_var</span><span class="p">(</span><span class="err">$</span><span class="n">redirect_uri</span><span class="p">,</span> <span class="n">FILTER_SANITIZE_URL</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>


<p>Once you have the credentials locally (in the form of <code class="highlighter-rouge">credentials.json</code>), you can just use it to access the drive API. Thus, the result of this whole exercise is that only on first page load is the user redirected to google site to authenticate themselves. Once the app has the access token (credentials.json), its no longer required, the drive can be accessed directly by the app from then on. If all goes well, you should be able to see a screen such as this when you test this example app for the first time:</p>
<div class="highlight"><pre><span></span>![Google OAuth Screen](/uploads/old/google-apis/oauth_screen_generic.png)
</pre></div>


<p>I’ll leave the more comprehensive use of this API as an exercise to the reader who wants to develop a more fully featured app out of this. Click the below link to download the source for this example implementation from the Github repo:</p>
<p><a class="btn btn-md btn-success" href="https://github.com/prahladyeri/php-drive-example/">php_drive_example</a></p>
<p>Note:</p>
<p>If you are getting an SSL certificate error while testing this on Windows, have a look at <a href="http://stackoverflow.com/questions/29822686/curl-error-60-ssl-certificate-unable-to-get-local-issuer-certificate">this</a>.</p>
    </div><!-- /.entry-content -->
	
	<!-- Start: Prahlad -->
	<!--start: adsense-->
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- mainsite_responsive -->
	<ins class="adsbygoogle"
		 style="display:block"
		 data-ad-client="ca-pub-0428291735937735"
		 data-ad-slot="6897031752"
		 data-ad-format="auto"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
	<!--end: adsense-->
	<!-- End: Prahlad -->

    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
		<script>
		/**
		*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
		
		/*var disqus_config = function () {
			this.page.url = 'https://prahladyeri.com/blog/2017/01/how-to-create-google-drive-app-php.html';  // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = 'blog/2017/01/how-to-create-google-drive-app-php.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		};
		(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://prahladyeri-blog.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
		})();*/
		</script>	  
	  
      <script type="text/javascript">
        var disqus_shortname = 'prahladyeri-blog';
        var disqus_identifier = 'blog/2017/01/how-to-create-google-drive-app-php.html';
        var disqus_url = 'https://prahladyeri.com/blog/2017/01/how-to-create-google-drive-app-php.html';
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//prahladyeri-blog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="mailto:prahladyeri@yahoo.com">Email</a></li>
                            <li><a href="https://github.com/prahladyeri/">Github</a></li>
                            <li><a href="https://stackoverflow.com/users/849365/prahlad-yeri/">StackOverflow</a></li>
                            <li><a href="https://www.quora.com/profile/Prahlad-Yeri">Quora</a></li>
                            <li><a href="https://mastodon.social/@prahladyeri">Mastodon.Social</a></li>
                            <li><a href="https://www.blogger.com/profile/12769325975373447545">Blogger</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://prahladyeri.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.linkedin.com/in/prahlad-yeri-243a5316">Linkedin</a></li>
                            <li><a href="https://www.facebook.com/prahladyeri14">Facebook</a></li>
                            <li><a href="https://twitter.com/prahladyeri">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Copyright (c) 2013-2019 <a href="/">Prahlad Yeri</a>.
				<br>
				This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-6808883-5', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'prahladyeri-blog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>